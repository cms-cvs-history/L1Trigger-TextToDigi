# Description:
#  test gct sequence: digi -> raw -> text -> raw -> digi
#  check consistency of input and output gct digi collections

process gctDigiToDigi = {
    
    //include "FWCore/MessageLogger/data/MessageLogger.cfi"
    service = MessageLogger {
    	untracked vstring destinations = { "debug.log" }
    	untracked PSet debug.log = { untracked string threshold = "DEBUG" } 
    	untracked vstring debugModules =  { 
    	    "gctDigiToRaw", "raw2text", "text2raw", "awToDigi", "l1Compare"
    	}
    }

    untracked PSet maxEvents = { untracked int32 input = -1 }
    
    source = PoolSource {
	untracked vstring fileNames = 	
	{'file:calodigis.root'}
    }
    
    
    # digi->raw
    module gctDigiToRaw = GctDigiToRaw {
	InputTag rctInputLabel = rctDigis
	InputTag gctInputLabel = gctDigis
	untracked bool verbose = false
	int32 gctFedId = 745
    }    

    # raw->text
    module raw2text = RawToText {
	InputTag inputLabel = gctDigiToRaw
	untracked string filename = "gct_tmp.txt"
	untracked int32 GctFedId = 745
    }

    # text->raw
    module text2raw = TextToRaw {
	untracked string filename = "gct_tmp.txt"
	untracked int32 GctFedId = 745
	untracked int32 FileEventOffset = 0
    }
 
    # raw->digi
    module RawToDigi = GctRawToDigi {
	//InputTag inputLabel = gctDigiToRaw //skip 'raw->txt->raw' !
	InputTag inputLabel = text2raw
	int32 gctFedId = 745
	untracked bool verbose = false
	untracked bool unpackInternEm = true
	untracked bool unpackFibres = true

    }

    module dump = DumpFEDRawDataProduct { 
	untracked vint32 feds = { 745 }
	untracked bool dumpPayload = true
    }
    
    # comparator
    include "L1Trigger/HardwareValidation/data/L1Comparator.cfi"
    //replace l1Compare.RCT_dataLabel = RawToDigi
    //replace l1Compare.RCT_emulLabel = rctDigis
    replace l1Compare.GCT_dataLabel = RawToDigi
    replace l1Compare.GCT_emulLabel = gctDigis
    replace l1Compare.DumpFile      = "dump.txt"
    # mode: display mismatches only (0) or all non-zero candidates (1)
    replace l1Compare.DumpMode      = 1
    replace l1Compare.COMPARE_COLLS = { 0,0,0,1,0,0,0,0,0,0,0,0 }
    # note: only gct em candidates should be compared
    #       with current unpacker implementation
    //      rct em cands not implemented in GctDigiToRaw yet

    path p = {
	gctDigiToRaw, dump
	,raw2text
	,text2raw
	,RawToDigi
	,l1Compare
    }
    
    module outputEvents = PoolOutputModule {
    	untracked string fileName = "gctDigiToDigi.root"
    }
    #endpath outpath = { outputEvents }
    
}
